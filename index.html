<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Canyoning Pacet</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; padding-bottom: 80px; }
    
    /* Header Utama */
    .header { background: #2c3e50; color: white; padding: 15px; text-align: center; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h2 { margin: 0; font-size: 1.2rem; }

    .container { max-width: 800px; margin: 0 auto; padding: 0 15px; }

    /* Controls */
    .controls { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; text-align: center; }
    select { padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; width: 100%; max-width: 100%; cursor: pointer; background: #fff; }

    /* Accordion List */
    .accordion-item { background: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
    .accordion-header { 
        padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; 
        background: #fff; transition: background 0.2s; border-bottom: 1px solid transparent;
    }
    .accordion-header:active { background: #f0f0f0; }
    .accordion-header .date { font-weight: 600; font-size: 1em; }
    .accordion-header .count { font-size: 0.8em; background: #eee; padding: 4px 10px; border-radius: 20px; color: #555; }
    
    .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    
    table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 100%; }
    th { background: #f8f9fa; text-align: left; padding: 10px; color: #666; font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #eee; white-space: nowrap; }
    td { padding: 10px; border-bottom: 1px solid #eee; color: #333; }
    
    /* === LOGIKA CORETAN & BATAL === */
    tr.row-done td {
        text-decoration: line-through;
        color: #bbb;
        background-color: #fafafa;
    }
    tr.row-done .btn-action {
        background-color: #6c757d; 
        color: #fff;
        border: none;
        cursor: pointer; 
    }
    tr.row-done .btn-action span { display: none; }
    tr.row-done .btn-action::after { content: "Lunas (Batal?)"; font-size: 0.9em; }

    /* Badges & Buttons */
    .badge { padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 0.75em; display: inline-block; }
    .badge-full { background: #ffebee; color: #c62828; } 
    .badge-dp { background: #fff3e0; color: #ef6c00; } 
    .badge-pic { background: #e8f5e9; color: #2e7d32; border-radius: 12px; }

    .btn-action {
        background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; width: 100%;
    }

    /* === MOBILE MODAL STYLES === */
    .modal {
        display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; 
        background-color: #f2f4f8; overflow: hidden; 
    }

    .modal-content {
        background-color: #f2f4f8; 
        width: 100%; height: 100%; 
        display: flex; flex-direction: column;
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

    .m-header {
        background: white; padding: 15px; display: flex; align-items: center; justify-content: space-between;
        box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 10;
    }
    .m-header h4 { margin: 0; font-size: 1.1rem; color: #333; }
    .m-header .close-btn { font-size: 1.5rem; cursor: pointer; color: #666; line-height: 1; padding: 0 10px; }

    .m-body { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }

    .card-section {
        background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .card-title {
        font-size: 0.85rem; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 0.5px;
    }

    .form-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #eee; }
    .form-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    
    .lbl-main { font-weight: 600; font-size: 0.95rem; color: #333; display: block; }
    .lbl-sub { font-size: 0.75rem; color: #999; display: block; margin-top: 2px; }

    .input-group { display: flex; gap: 8px; align-items: center; }
    .inp-qty { width: 50px; text-align: center; padding: 10px 5px; border: 1px solid #ddd; border-radius: 6px; font-weight: bold; font-size: 1rem; }
    .inp-price { width: 100px; text-align: right; padding: 10px; border: 1px solid #ddd; border-radius: 6px; color: #333; font-size: 0.95rem; }
    .inp-full { width: 100%; text-align: left; }

    .m-footer {
        background: white; padding: 15px; border-top: 1px solid #e0e0e0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 10;
    }
    
    .total-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .total-lbl { font-size: 0.9rem; color: #666; }
    .total-val { font-size: 1.3rem; font-weight: 800; color: #2c3e50; }
    .total-val.red { color: #d32f2f; }
    .total-val.green { color: #2e7d32; }

    .btn-print { width: 100%; background: #2c3e50; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
    .btn-print:active { transform: scale(0.98); }

    /* === RECEIPT STYLE (PRO UPDATE) === */
    #receiptContainer { display: none; }

    @media print {
        @page { margin: 0; size: auto; }
        body { margin: 0; font-family: 'Courier New', Courier, monospace; }
        body * { visibility: hidden; }
        
        #receiptContainer, #receiptContainer * { visibility: visible; }
        #receiptContainer {
            display: block; position: absolute; left: 0; top: 0; width: 100%;
            background: white; color: black;
            padding: 10px 20px; box-sizing: border-box;
            font-size: 12px;
        }
        
        /* Header Title */
        .rc-header { text-align: center; margin-bottom: 10px; }
        .rc-title { font-size: 18px; font-weight: 900; margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 1px; }
        .rc-address { font-size: 10px; color: #000; margin-bottom: 2px; line-height: 1.2; }
        
        /* Separator Line */
        .rc-line { border-bottom: 1px dashed #000; margin: 8px 0; display: block; width: 100%; }

        /* Transaction Info */
        .rc-meta { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 2px; }
        .rc-meta-label { font-weight: bold; }
        
        /* Table Items */
        .rc-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 11px; }
        .rc-table th { text-align: left; padding: 5px 0; border-bottom: 1px dashed #000; text-transform: uppercase; font-size: 10px; }
        .rc-table td { padding: 4px 0; vertical-align: top; }
        .rc-right { text-align: right; }
        .rc-center { text-align: center; }
        
        /* Totals Area */
        .rc-totals { margin-top: 5px; }
        .rc-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 11px; }
        .rc-grand-box { 
            border-top: 2px dashed #000; 
            border-bottom: 2px dashed #000; 
            padding: 8px 0; margin-top: 5px; margin-bottom: 10px;
            font-weight: 900; font-size: 16px; 
            display: flex; justify-content: space-between;
        }

        /* Footer */
        .rc-footer { text-align: center; margin-top: 15px; font-size: 10px; color: #000; }
        
        /* Fake Barcode using CSS */
        .barcode {
            height: 35px; width: 80%; margin: 15px auto 5px auto;
            background: repeating-linear-gradient(
                90deg,
                #000 0px, #000 2px,
                #fff 2px, #fff 4px,
                #000 4px, #000 5px,
                #fff 5px, #fff 7px
            );
        }
        
        .modal, .header, #app { display: none !important; }
    }
    
    #loading { text-align: center; margin-top: 50vh; transform: translateY(-50%); color: #666; }
    .error-msg { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 8px; text-align: center; margin: 20px; }
    #secretSection { display: none; }
    .summary-box { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #2e7d32; }
    .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .secret-container { text-align: center; margin-top: 30px; opacity: 0.1; }
    .secret-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; width: 80px; }

    /* RESET BUTTON (Admin) */
    .reset-cache { display: block; margin: 20px auto; padding: 10px; background: #d32f2f; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight:bold; }

</style>
</head>
<body>

<div class="header">
    <h2>Jadwal Canyoning</h2>
</div>

<div id="loading">
    <div style="font-size: 2em;">‚è≥</div>
    <p>Memuat Data...</p>
</div>

<div id="app" style="display:none;">
    <div class="container">
        <div class="controls">
            <select id="sheetSelector"></select>
        </div>
        <div id="scheduleList"></div>
    </div>

    <div class="container" id="secretSection">
        <div class="summary-box">
            <h3 style="margin:0 0 10px 0; color:#2c3e50; font-size:1.1rem;">üìä Rekapitulasi PIC</h3>
            <div id="picSummary"></div>
        </div>
        <button class="reset-cache" onclick="clearPaidStatus()">‚ö†Ô∏è Reset Semua Status Lunas</button>
    </div>
    <div class="container secret-container">
        <input type="password" id="adminKey" class="secret-input">
    </div>
</div>

<div id="paymentModal" class="modal">
    <div class="modal-content">
        
        <input type="hidden" id="inpPICName" value="Admin">

        <div class="m-header">
            <div>
                <h4 id="modalName">Nama Tamu</h4>
                <small id="modalDateInfo" style="color:#888;">Tanggal: -</small>
            </div>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>

        <div class="m-body">
            
            <div class="card-section">
                <span class="card-title">Paket Utama</span>
                <div class="form-row">
                    <div><span class="lbl-main">üë• Pax</span><span class="lbl-sub">Jumlah Tamu</span></div>
                    <div class="input-group">
                        <input type="number" id="inpPaxQty" class="inp-qty" value="0" min="1" oninput="calculate()">
                        <input type="number" id="inpPaxPrice" class="inp-price" value="300000" oninput="calculate()">
                    </div>
                </div>
            </div>

            <div class="card-section">
                <span class="card-title">Add-ons / Tambahan</span>
                <div class="form-row">
                    <div><span class="lbl-main">üëü Sepatu</span><span class="lbl-sub">@15.000</span></div>
                    <div class="input-group">
                        <input type="number" id="inpShoeQty" class="inp-qty" value="0" min="0" oninput="calculate()" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div><span class="lbl-main">üöê Shuttle</span><span class="lbl-sub">@10.000</span></div>
                    <div class="input-group">
                        <input type="number" id="inpShuttleQty" class="inp-qty" value="0" min="0" oninput="calculate()" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div><span class="lbl-main">üéüÔ∏è Tiket</span><span class="lbl-sub">@15.000</span></div>
                    <div class="input-group">
                        <input type="number" id="inpTiketQty" class="inp-qty" value="0" min="0" oninput="calculate()" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div><span class="lbl-main">üèçÔ∏è Ojek</span><span class="lbl-sub">@15.000</span></div>
                    <div class="input-group">
                        <input type="number" id="inpOjekQty" class="inp-qty" value="0" min="0" oninput="calculate()" placeholder="0">
                    </div>
                </div>
            </div>

            <div class="card-section">
                <span class="card-title">Dokumentasi</span>
                <div class="form-row">
                    <div><span class="lbl-main">üöÅ Cinematic</span><span class="lbl-sub">@100.000</span></div>
                    <div class="input-group">
                        <input type="number" id="inpDroneQty" class="inp-qty" value="0" min="0" oninput="calculate()" placeholder="0">
                    </div>
                </div>
                <div class="form-row">
                    <div><span class="lbl-main">üé¨ Drone Mentah</span><span class="lbl-sub">@50.000</span></div>
                    <div class="input-group">
                        <input type="number" id="inpCineQty" class="inp-qty" value="0" min="0" oninput="calculate()" placeholder="0">
                    </div>
                </div>
            </div>

            <div class="card-section" style="border-left: 4px solid #2e7d32;">
                <span class="card-title" style="color:#2e7d32;">‚ûï Optional / Manual</span>
                <div style="margin-bottom:10px;">
                    <input type="text" id="inpOptName" class="inp-price inp-full" placeholder="Nama Biaya Tambahan..." oninput="calculate()">
                </div>
                <div class="form-row">
                    <div><span class="lbl-main">Biaya</span></div>
                    <div class="input-group">
                        <input type="number" id="inpOptQty" class="inp-qty" value="0" min="0" oninput="calculate()" placeholder="Qty">
                        <input type="number" id="inpOptPrice" class="inp-price" value="0" oninput="calculate()" placeholder="Rp">
                    </div>
                </div>
            </div>

            <div class="card-section" style="background:#e3f2fd; border:1px solid #bbdefb;">
                <div class="form-row">
                    <div><span class="lbl-main" style="color:#0d47a1;">üí≥ Sudah DP</span><span class="lbl-sub">Auto dari Kolom DP</span></div>
                    <div class="input-group">
                        <input type="number" id="inpDP" class="inp-price" style="width:140px; font-weight:bold; color:#0d47a1; background:#fff;" value="0" oninput="calculate()">
                    </div>
                </div>
            </div>

            <div style="padding:0 5px 20px 5px; color:#666; font-size:0.85rem;">
                <div style="display:flex; justify-content:space-between;"><span>Paket:</span><span id="dispPaket">0</span></div>
                <div style="display:flex; justify-content:space-between;"><span>Add-ons:</span><span id="dispAddons">0</span></div>
                <div style="display:flex; justify-content:space-between; color:#2e7d32;"><span id="lblOptional">Optional:</span><span id="dispOptional">0</span></div>
            </div>
        </div>

        <div class="m-footer">
            <div class="total-display">
                <span class="total-lbl">Kekurangan Bayar:</span>
                <span id="dispFinal" class="total-val">0</span>
            </div>
            <button class="btn-print" onclick="printReceipt()">üñ®Ô∏è CETAK NOTA</button>
        </div>

    </div>
</div>

<div id="receiptContainer">
    <div class="rc-header">
        <div class="rc-title">CANYONING PACET</div>
        <div class="rc-address">Jl. Wisata Air Panas KM. 0</div>
        <div class="rc-address">Padusan, Mojokerto, Jawa Timur</div>
    </div>
    
    <div class="rc-line"></div>
    
    <div class="rc-meta">
        <span>No. Trx: <span id="rcTrxId" style="font-weight:bold;"></span></span>
        <span id="rcTime"></span>
    </div>
    <div class="rc-meta">
        <span>Tamu: <span id="rcName" style="font-weight:bold; text-transform:uppercase;"></span></span>
    </div>
     <div class="rc-meta">
        <span>Kasir: <span id="rcCashier"></span></span>
        <span id="rcDate"></span>
    </div>

    <div class="rc-line"></div>

    <table class="rc-table">
        <thead>
            <tr>
                <th style="width:50%;">ITEM</th>
                <th class="rc-center" style="width:15%;">QTY</th>
                <th class="rc-right" style="width:35%;">TOTAL</th>
            </tr>
        </thead>
        <tbody id="rcBody"></tbody>
    </table>

    <div class="rc-line"></div>

    <div class="rc-totals">
        <div class="rc-row"><span>Subtotal</span><span id="rcSubtotal">0</span></div>
        <div class="rc-row"><span>Sudah DP</span><span id="rcDP">0</span></div>
        <div class="rc-grand-box">
            <span id="rcLabelFinal">KEKURANGAN</span>
            <span id="rcFinal">0</span>
        </div>
    </div>

    <div class="rc-footer">
        <p>Terima Kasih atas kunjungan Anda.<br>Selamat Berpetualang!</p>
        <div class="barcode"></div>
        <div style="font-size:9px; margin-top:5px;">*** SIMPAN STRUK INI ***</div>
    </div>
</div>


<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzcDMlGtcoO2yY1wFd-ZMTyk3hs-dOmlUhnKd-rryL5JYAQSx-R07wRiP-A6D3bPl6Shg/exec"; 
    const SECRET_KEY = "adminslot"; 
    const PRICES = { SHOE: 15000, SHUTTLE: 10000, TIKET: 15000, OJEK: 15000, DRONE: 100000, CINEMATIC: 50000 };

    let CACHED_DATA = []; 
    let CACHED_HEADERS = []; 
    let activeRowElement = null; 
    let activeRowID = null; 

    document.addEventListener("DOMContentLoaded", init);

    async function init() {
        const loading = document.getElementById('loading');
        const keyInput = document.getElementById('adminKey');
        
        keyInput.addEventListener('input', function(e) {
            const secretDiv = document.getElementById('secretSection');
            if (e.target.value === SECRET_KEY) {
                secretDiv.style.display = 'block';
                renderSummary(CACHED_DATA);
                e.target.style.borderColor = "#2e7d32";
            } else {
                secretDiv.style.display = 'none';
                e.target.style.borderColor = "#ccc";
            }
        });

        try {
            if (SCRIPT_URL.includes("MASUKKAN")) throw new Error("Link Apps Script belum dimasukkan.");
            let response = await fetch(SCRIPT_URL);
            let sheets = await response.json();
            if (!sheets || sheets.length === 0) throw new Error("Tidak ada sheet ditemukan.");

            const now = new Date();
            const currentMonthName = new Intl.DateTimeFormat('id-ID', { month: 'long' }).format(now);
            const currentYear = now.getFullYear();
            const currentPeriod = `${currentMonthName} ${currentYear}`.toLowerCase();

            const select = document.getElementById('sheetSelector');
            let matchedGid = sheets[0].gid;

            sheets.forEach(sheet => {
                let opt = document.createElement('option');
                opt.value = sheet.gid;
                opt.innerText = sheet.name;
                if (sheet.name.toLowerCase().includes(currentPeriod)) {
                    matchedGid = sheet.gid;
                }
                select.appendChild(opt);
            });
            select.value = matchedGid;
            loading.style.display = 'none';
            document.getElementById('app').style.display = 'block';
            loadSheetData(matchedGid);
            select.addEventListener('change', (e) => loadSheetData(e.target.value));
        } catch (err) {
            loading.innerHTML = `<div class="error-msg"><strong>Error:</strong><br>${err.message}</div>`;
        }
    }

    async function loadSheetData(gid) {
        const container = document.getElementById('scheduleList');
        const summaryDiv = document.getElementById('secretSection');
        container.innerHTML = "<p style='text-align:center; color:#888;'>Memuat data...</p>";
        summaryDiv.style.display = 'none'; 
        document.getElementById('adminKey').value = '';

        try {
            let res = await fetch(`${SCRIPT_URL}?gid=${gid}`);
            let rawData = await res.json();
            if (!rawData || rawData.length < 2) {
                container.innerHTML = "<p style='text-align:center; padding:20px;'>Data kosong.</p>";
                CACHED_DATA = []; CACHED_HEADERS = []; return;
            }
            const headers = rawData[0];
            CACHED_HEADERS = headers; 
            const rows = rawData.slice(1);
            const cleanData = processData(rows);
            CACHED_DATA = cleanData;
            renderSchedule(headers, cleanData);
        } catch (err) {
            container.innerHTML = `<div class="error-msg">Gagal memuat data.<br>${err.message}</div>`;
        }
    }

    function processData(rows) {
        let result = []; let lastDate = null;
        rows.forEach(row => {
            let newRow = [...row];
            let date = newRow[0];
            let hasContent = newRow.slice(1).some(cell => cell && cell.toString().trim() !== "");
            if ((!date || date.toString().trim() === "") && lastDate && hasContent) { newRow[0] = lastDate; } 
            else if (date && date.toString().trim() !== "") { lastDate = date; } 
            else { return; }
            result.push(newRow);
        });
        return result;
    }

    function renderSchedule(headers, data) {
        let groups = {};
        data.forEach(row => {
            let d = row[0];
            if (!groups[d]) groups[d] = [];
            groups[d].push(row);
        });

        const container = document.getElementById('scheduleList');
        container.innerHTML = "";
        let displayHeaders = [...headers, "Bayar"]; 

        for (let date in groups) {
            let items = groups[date];
            let totalGuest = items.reduce((sum, r) => sum + (parseInt(r[1]) || 0), 0);
            let displayText = totalGuest >= 17 ? "FULL SLOT" : `${totalGuest} Tamu`;
            let displayStyle = totalGuest >= 17 ? "background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; font-weight: bold;" : "";

            let itemDiv = document.createElement('div');
            itemDiv.className = 'accordion-item';
            let headerDiv = document.createElement('div');
            headerDiv.className = 'accordion-header';
            headerDiv.innerHTML = `<span class="date">${date}</span><span class="count" style="${displayStyle}">${displayText}</span>`;
            
            let bodyDiv = document.createElement('div');
            bodyDiv.className = 'accordion-body';
            
            let tableHTML = `<div class="table-responsive"><table><thead><tr>`;
            for(let i=1; i<displayHeaders.length; i++) tableHTML += `<th>${displayHeaders[i] || '-'}</th>`;
            tableHTML += `</tr></thead><tbody>`;

            items.forEach(row => {
                let rowID = `BID_${row[0]}_${row[2]}_${row[1]}`.replace(/\s/g, '');
                let isDone = localStorage.getItem(rowID) === "true";
                let rowClass = isDone ? "row-done" : "";

                tableHTML += `<tr class="${rowClass}" data-id="${rowID}">`;
                for(let i=1; i<headers.length; i++) {
                    let text = row[i] || "";
                    let cellContent = text;
                    let lowerText = text.toString().toLowerCase();
                    if(lowerText.includes('full')) cellContent = `<span class="badge badge-full">${text}</span>`;
                    else if(lowerText.includes('dp') || lowerText.includes('lunas')) cellContent = `<span class="badge badge-dp">${text}</span>`;
                    tableHTML += `<td>${cellContent}</td>`;
                }
                let rowDataString = JSON.stringify(row).replace(/"/g, '&quot;');
                tableHTML += `<td><button class="btn-action" onclick="openPaymentModal(${rowDataString}, this)"><span>Hitung</span></button></td>`;
                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            
            bodyDiv.innerHTML = tableHTML;
            itemDiv.appendChild(headerDiv);
            itemDiv.appendChild(bodyDiv);
            container.appendChild(itemDiv);

            headerDiv.addEventListener('click', function() {
                this.classList.toggle('active');
                if (bodyDiv.style.maxHeight) bodyDiv.style.maxHeight = null;
                else bodyDiv.style.maxHeight = bodyDiv.scrollHeight + "px";
            });
        }
    }

    function renderSummary(data) {
        let picMap = {}; let grandTotal = 0;
        data.forEach(row => {
            let qty = parseInt(row[1]) || 0; 
            let pic = row[3]; 
            if (qty > 0 && pic && pic.trim() !== '-' && pic.trim() !== '') {
                let name = pic.trim().toLowerCase().replace(/\b\w/g, c => c.toUpperCase()); 
                picMap[name] = (picMap[name] || 0) + qty;
                grandTotal += qty;
            }
        });
        let sorted = Object.entries(picMap).sort((a,b) => b[1] - a[1]);
        let html = "";
        if (sorted.length === 0) { html = "<p style='text-align:center'>Tidak ada data.</p>"; } 
        else {
            sorted.forEach(([name, count]) => { html += `<div class="summary-row"><span>${name}</span><span class="badge badge-pic">${count}</span></div>`; });
            html += `<div class="summary-row"><span>TOTAL</span><span>${grandTotal}</span></div>`;
        }
        document.getElementById('picSummary').innerHTML = html;
    }

    function formatRupiah(num) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
    }

    function openPaymentModal(row, btnElement) {
        if (btnElement && btnElement.closest('tr').classList.contains('row-done')) {
            if(confirm("Batalkan status LUNAS untuk tamu ini?")) {
                let tr = btnElement.closest('tr');
                let id = tr.getAttribute('data-id');
                localStorage.removeItem(id); 
                tr.classList.remove('row-done'); 
            }
            return; 
        }

        if(btnElement) {
            activeRowElement = btnElement.closest('tr');
            activeRowID = activeRowElement.getAttribute('data-id');
        }

        const modal = document.getElementById("paymentModal");
        let pax = parseInt(row[1]) || 0;
        
        document.getElementById("modalName").innerText = row[2] || "Tamu";
        document.getElementById("modalDateInfo").innerText = "Tanggal: " + row[0];

        // --- AMBIL PIC DARI DATA ROW (Index 3) ---
        let picName = row[3];
        if(picName && picName !== "-") {
            // Format Title Case (Huruf depan besar)
            picName = picName.trim().replace(/\b\w/g, c => c.toUpperCase());
        } else {
            picName = "Admin";
        }
        document.getElementById("inpPICName").value = picName;
        // ----------------------------------------

        // Defaults
        document.getElementById("inpPaxQty").value = pax;
        document.getElementById("inpPaxPrice").value = 300000; 
        document.getElementById("inpShoeQty").value = 0;   
        document.getElementById("inpShuttleQty").value = 0; 
        document.getElementById("inpTiketQty").value = 0; 
        document.getElementById("inpOjekQty").value = 0;     
        document.getElementById("inpDroneQty").value = 0;     
        document.getElementById("inpCineQty").value = 0;     
        document.getElementById("inpOptQty").value = 0;
        document.getElementById("inpOptPrice").value = 0;
        document.getElementById("inpOptName").value = "Optional / Lainnya";

        let dpValue = 0;
        let dpIndex = CACHED_HEADERS.findIndex(h => h.toLowerCase().includes('dp'));
        if (dpIndex !== -1 && row[dpIndex]) {
            let rawString = row[dpIndex].toString();
            let cleanString = rawString.replace(/[^0-9]/g, ''); 
            dpValue = parseFloat(cleanString) || 0;
        }
        document.getElementById("inpDP").value = dpValue;

        calculate(); 
        modal.style.display = "block"; 
    }

    function closeModal() {
        document.getElementById("paymentModal").style.display = "none";
    }

    function calculate() {
        let qtyPax = parseFloat(document.getElementById("inpPaxQty").value) || 0;
        let pricePax = parseFloat(document.getElementById("inpPaxPrice").value) || 0;
        let qtyShoe = parseFloat(document.getElementById("inpShoeQty").value) || 0;
        let qtyShuttle = parseFloat(document.getElementById("inpShuttleQty").value) || 0;
        let qtyTiket = parseFloat(document.getElementById("inpTiketQty").value) || 0;
        let qtyOjek = parseFloat(document.getElementById("inpOjekQty").value) || 0;
        let qtyDrone = parseFloat(document.getElementById("inpDroneQty").value) || 0;
        let qtyCine = parseFloat(document.getElementById("inpCineQty").value) || 0;
        let qtyOpt = parseFloat(document.getElementById("inpOptQty").value) || 0;
        let priceOpt = parseFloat(document.getElementById("inpOptPrice").value) || 0;
        let nameOpt = document.getElementById("inpOptName").value || "Optional";
        let valDP = parseFloat(document.getElementById("inpDP").value) || 0;

        let totalPaket = qtyPax * pricePax;
        let totalAddons = (qtyShoe*PRICES.SHOE) + (qtyShuttle*PRICES.SHUTTLE) + (qtyTiket*PRICES.TIKET) + (qtyOjek*PRICES.OJEK) + (qtyDrone*PRICES.DRONE) + (qtyCine*PRICES.CINEMATIC) + (qtyOpt*priceOpt);
        let grandTotal = totalPaket + totalAddons;
        let finalAmount = grandTotal - valDP;

        document.getElementById("dispPaket").innerText = formatRupiah(totalPaket);
        document.getElementById("dispAddons").innerText = formatRupiah(totalAddons - (qtyOpt*priceOpt));
        document.getElementById("lblOptional").innerText = nameOpt + ":";
        document.getElementById("dispOptional").innerText = "+ " + formatRupiah(qtyOpt*priceOpt);
        
        let elFinal = document.getElementById("dispFinal");
        if (finalAmount > 0) {
            elFinal.innerText = formatRupiah(finalAmount); elFinal.className = "total-val red";
        } else if (finalAmount < 0) {
            elFinal.innerText = "KEMBALI " + formatRupiah(Math.abs(finalAmount)); elFinal.className = "total-val green";
        } else {
            elFinal.innerText = "LUNAS"; elFinal.className = "total-val green";
        }
    }

    function printReceipt() {
        const name = document.getElementById("modalName").innerText;
        const picName = document.getElementById("inpPICName").value; // Ambil PIC yang disimpan
        
        // --- LOGIC TANGGAL & TRX ID ---
        const today = new Date();
        const dateStr = new Intl.DateTimeFormat('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }).format(today);
        const timeStr = new Intl.DateTimeFormat('id-ID', { hour: '2-digit', minute: '2-digit' }).format(today);
        
        const randomNum = Math.floor(Math.random() * 900) + 100;
        const trxId = "TRX-" + today.getDate() + (today.getMonth()+1) + "-" + randomNum;

        const qtyPax = parseFloat(document.getElementById("inpPaxQty").value) || 0;
        const pricePax = parseFloat(document.getElementById("inpPaxPrice").value) || 0;
        
        let tbody = document.getElementById("rcBody");
        tbody.innerHTML = "";
        let grandTotal = 0;

        function addRow(name, qty, price) {
            if (qty > 0) {
                let total = qty * price;
                grandTotal += total;
                tbody.innerHTML += `<tr><td>${name}</td><td class="rc-center">${qty}</td><td class="rc-right">${formatRupiah(total)}</td></tr>`;
            }
        }

        addRow("Paket Canyoning", qtyPax, pricePax);
        addRow("Sewa Sepatu", parseFloat(document.getElementById("inpShoeQty").value)||0, PRICES.SHOE);
        addRow("Shuttle", parseFloat(document.getElementById("inpShuttleQty").value)||0, PRICES.SHUTTLE);
        addRow("Tiket", parseFloat(document.getElementById("inpTiketQty").value)||0, PRICES.TIKET);
        addRow("Ojek", parseFloat(document.getElementById("inpOjekQty").value)||0, PRICES.OJEK);
        addRow("Cinematic", parseFloat(document.getElementById("inpDroneQty").value)||0, PRICES.DRONE);
        addRow("Drone Mentah", parseFloat(document.getElementById("inpCineQty").value)||0, PRICES.CINEMATIC);
        addRow(document.getElementById("inpOptName").value || "Optional", parseFloat(document.getElementById("inpOptQty").value)||0, parseFloat(document.getElementById("inpOptPrice").value)||0);

        // Isi Data ke HTML Receipt
        document.getElementById("rcTrxId").innerText = trxId;
        document.getElementById("rcName").innerText = name;
        document.getElementById("rcDate").innerText = dateStr;
        document.getElementById("rcTime").innerText = timeStr;
        document.getElementById("rcCashier").innerText = picName; // SET NAMA KASIR DISINI
        document.getElementById("rcSubtotal").innerText = formatRupiah(grandTotal);
        
        let valDP = parseFloat(document.getElementById("inpDP").value) || 0;
        document.getElementById("rcDP").innerText = formatRupiah(valDP);
        
        let final = grandTotal - valDP;
        let lblFinal = document.getElementById("rcLabelFinal");
        let valFinal = document.getElementById("rcFinal");
        
        if(final > 0) { lblFinal.innerText = "TAGIHAN"; valFinal.innerText = formatRupiah(final); } 
        else if(final < 0) { lblFinal.innerText = "KEMBALI"; valFinal.innerText = formatRupiah(Math.abs(final)); } 
        else { lblFinal.innerText = "STATUS"; valFinal.innerText = "LUNAS"; }

        // --- SIMPAN KE LOCAL STORAGE ---
        if(activeRowElement && activeRowID) {
            activeRowElement.classList.add('row-done');
            localStorage.setItem(activeRowID, "true");
        }

        window.print();
    }
    
    function clearPaidStatus() {
        if(confirm("Yakin hapus semua status lunas di HP ini?")) {
            localStorage.clear();
            location.reload();
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById("paymentModal");
        if (event.target == modal) { }
    }
</script>

</body>
</html>
