<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Canyoning Pacet Mojokerto</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; padding-bottom: 80px; }
    
    /* Header Utama */
    .header { background: #2c3e50; color: white; padding: 15px; text-align: center; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h2 { margin: 0; font-size: 1.2rem; }

    .container { max-width: 800px; margin: 0 auto; padding: 0 15px; }

    /* Controls */
    .controls { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; text-align: center; }
    select { padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; width: 100%; max-width: 100%; cursor: pointer; background: #fff; }

    /* Accordion List */
    .accordion-item { background: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
    .accordion-header { 
        padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; 
        background: #fff; transition: background 0.2s; border-bottom: 1px solid transparent;
    }
    .accordion-header:active { background: #f0f0f0; }
    .accordion-header .date { font-weight: 600; font-size: 1em; }
    .accordion-header .count { font-size: 0.8em; background: #eee; padding: 4px 10px; border-radius: 20px; color: #555; }
    
    .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    
    table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 100%; }
    th { background: #f8f9fa; text-align: left; padding: 10px; color: #666; font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #eee; white-space: nowrap; }
    td { padding: 10px; border-bottom: 1px solid #eee; color: #333; }
    
    /* === LOGIKA CORETAN & BATAL === */
    tr.row-done td {
        text-decoration: line-through;
        color: #bbb;
        background-color: #fafafa;
    }
    tr.row-done .btn-action {
        background-color: #6c757d; 
        color: #fff;
        border: none;
        cursor: pointer;
    }
    tr.row-done .btn-action span { display: none; }
    tr.row-done .btn-action::after { content: "Lunas (Batal?)"; font-size: 0.9em; }

    .badge { padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 0.75em; display: inline-block; }
    .badge-full { background: #ffebee; color: #c62828; } 
    .badge-dp { background: #fff3e0; color: #ef6c00; } 
    .badge-pic { background: #e8f5e9; color: #2e7d32; border-radius: 12px; }

    .btn-action {
        background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; width: 100%;
    }

    /* === MODAL STYLES === */
    .modal {
        display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; 
        background-color: #f2f4f8; overflow: hidden; 
    }
    .modal-content {
        background-color: #f2f4f8; width: 100%; height: 100%; 
        display: flex; flex-direction: column;
        animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    .m-header { background: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 5px rgba(0,0,0,0.05); z-index: 10; }
    .m-header h4 { margin: 0; font-size: 1.1rem; color: #333; }
    .m-header .close-btn { font-size: 1.5rem; cursor: pointer; color: #666; line-height: 1; padding: 0 10px; }
    .m-body { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
    .card-section { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .card-title { font-size: 0.85rem; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 0.5px; }
    .form-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #eee; }
    .form-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .lbl-main { font-weight: 600; font-size: 0.95rem; color: #333; display: block; }
    .lbl-sub { font-size: 0.75rem; color: #999; display: block; margin-top: 2px; }
    .input-group { display: flex; gap: 8px; align-items: center; }
    .inp-qty { width: 50px; text-align: center; padding: 10px 5px; border: 1px solid #ddd; border-radius: 6px; font-weight: bold; font-size: 1rem; }
    .inp-price { width: 100px; text-align: right; padding: 10px; border: 1px solid #ddd; border-radius: 6px; color: #333; font-size: 0.95rem; }
    .inp-full { width: 100%; text-align: left; }
    .m-footer { background: white; padding: 15px; border-top: 1px solid #e0e0e0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 10; }
    .total-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .total-lbl { font-size: 0.9rem; color: #666; }
    .total-val { font-size: 1.3rem; font-weight: 800; color: #2c3e50; }
    .total-val.red { color: #d32f2f; }
    .total-val.green { color: #2e7d32; }
    .btn-print { width: 100%; background: #2c3e50; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }

    /* === RECEIPT & WATERMARK STYLE === */
    #receiptContainer { display: none; position: relative; overflow: hidden; }
    
    /* Gaya Logo Background */
    .rc-watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-30deg);
        width: 80%;
        opacity: 40; /* Sangat transparan agar teks terbaca */
        z-index: -1;
        display: none;
    }

    @media print {
        body * { visibility: hidden; }
        #receiptContainer, #receiptContainer * { visibility: visible; }
        #receiptContainer {
            display: block !important; position: absolute; left: 0; top: 0; width: 100%;
            background: white; color: black; font-family: 'Courier New', Courier, monospace; padding: 20px; box-sizing: border-box;
        }
        .rc-watermark { display: block !important; } /* Munculkan logo saat print */
        .rc-header { text-align: center; margin-bottom: 20px; border-bottom: 2px dashed #000; padding-bottom: 10px; }
        .rc-title { font-size: 1.5rem; font-weight: bold; margin: 0; }
        .rc-subtitle { font-size: 0.9rem; color: #333; margin: 5px 0; }
        .rc-info { margin-bottom: 15px; font-size: 0.9rem; }
        .rc-info div { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .rc-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .rc-table th { border-bottom: 1px solid #000; text-align: left; padding: 5px 0; font-size: 0.8rem; }
        .rc-table td { padding: 5px 0; font-size: 0.9rem; vertical-align: top; }
        .rc-right { text-align: right; }
        .rc-qty { width: 30px; text-align: center; }
        .rc-totals { border-top: 2px dashed #000; padding-top: 10px; }
        .rc-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 1rem; }
        .rc-grand { font-weight: bold; font-size: 1.2rem; margin-top: 5px; border-top: 1px solid #000; padding-top: 5px; }
        .rc-footer { text-align: center; margin-top: 30px; font-size: 0.8rem; color: #555; }
        .modal, .header, #app { display: none !important; }
    }
    
    #loading { text-align: center; margin-top: 50vh; transform: translateY(-50%); color: #666; }
    .error-msg { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 8px; text-align: center; margin: 20px; }
    #secretSection { display: none; }
    .summary-box { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 4px solid #2e7d32; }
    .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .secret-container { text-align: center; margin-top: 30px; opacity: 0.1; }
    .secret-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; width: 80px; }
    .reset-cache { display: block; margin: 20px auto; padding: 10px; background: #d32f2f; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight:bold; }
</style>
</head>
<body>

<div class="header">
    <h2>Jadwal Canyoning</h2>
</div>

<div id="loading">
    <div style="font-size: 2em;">‚è≥</div>
    <p>Memuat Data...</p>
</div>

<div id="app" style="display:none;">
    <div class="container">
        <div class="controls">
            <select id="sheetSelector"></select>
        </div>
        <div id="scheduleList"></div>
    </div>
    <div class="container" id="secretSection">
        <div class="summary-box">
            <h3 style="margin:0 0 10px 0; color:#2c3e50; font-size:1.1rem;">üìä Rekapitulasi PIC</h3>
            <div id="picSummary"></div>
        </div>
        <button class="reset-cache" onclick="clearPaidStatus()">‚ö†Ô∏è Reset Semua Status Lunas</button>
    </div>
    <div class="container secret-container">
        <input type="password" id="adminKey" class="secret-input">
    </div>
</div>

<div id="paymentModal" class="modal">
    <div class="modal-content">
        <div class="m-header">
            <div>
                <h4 id="modalName">Nama Tamu</h4>
                <small id="modalDateInfo" style="color:#888;">Tanggal: -</small>
            </div>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>
        <div class="m-body">
            <div class="card-section">
                <span class="card-title">Paket Utama</span>
                <div class="form-row">
                    <div><span class="lbl-main">üë• Pax</span><span class="lbl-sub">Jumlah Tamu</span></div>
                    <div class="input-group">
                        <input type="number" id="inpPaxQty" class="inp-qty" value="0" min="1" oninput="calculate()">
                        <input type="number" id="inpPaxPrice" class="inp-price" value="300000" oninput="calculate()">
                    </div>
                </div>
            </div>
            <div class="card-section">
                <span class="card-title">Add-ons / Tambahan</span>
                <div class="form-row"><div><span class="lbl-main">üëü Sepatu</span><span class="lbl-sub">@15.000</span></div><div class="input-group"><input type="number" id="inpShoeQty" class="inp-qty" value="0" min="0" oninput="calculate()"></div></div>
                <div class="form-row"><div><span class="lbl-main">üöê Shuttle</span><span class="lbl-sub">@10.000</span></div><div class="input-group"><input type="number" id="inpShuttleQty" class="inp-qty" value="0" min="0" oninput="calculate()"></div></div>
                <div class="form-row"><div><span class="lbl-main">üéüÔ∏è Tiket</span><span class="lbl-sub">@15.000</span></div><div class="input-group"><input type="number" id="inpTiketQty" class="inp-qty" value="0" min="0" oninput="calculate()"></div></div>
                <div class="form-row"><div><span class="lbl-main">üèçÔ∏è Ojek</span><span class="lbl-sub">@15.000</span></div><div class="input-group"><input type="number" id="inpOjekQty" class="inp-qty" value="0" min="0" oninput="calculate()"></div></div>
            </div>
            <div class="card-section">
                <span class="card-title">Dokumentasi</span>
                <div class="form-row"><div><span class="lbl-main">üöÅ Drone</span><span class="lbl-sub">@100.000</span></div><div class="input-group"><input type="number" id="inpDroneQty" class="inp-qty" value="0" min="0" oninput="calculate()"></div></div>
                <div class="form-row"><div><span class="lbl-main">üé¨ Cinematic</span><span class="lbl-sub">@50.000</span></div><div class="input-group"><input type="number" id="inpCineQty" class="inp-qty" value="0" min="0" oninput="calculate()"></div></div>
            </div>
            <div class="card-section" style="border-left: 4px solid #2e7d32;">
                <span class="card-title" style="color:#2e7d32;">‚ûï Optional / Manual</span>
                <div style="margin-bottom:10px;"><input type="text" id="inpOptName" class="inp-price inp-full" placeholder="Nama Biaya Tambahan..." oninput="calculate()"></div>
                <div class="form-row"><div><span class="lbl-main">Biaya</span></div><div class="input-group"><input type="number" id="inpOptQty" class="inp-qty" value="0" min="0" oninput="calculate()"><input type="number" id="inpOptPrice" class="inp-price" value="0" oninput="calculate()"></div></div>
            </div>
            <div class="card-section" style="background:#e3f2fd; border:1px solid #bbdefb;">
                <div class="form-row"><div><span class="lbl-main" style="color:#0d47a1;">üí≥ Sudah DP</span></div><div class="input-group"><input type="number" id="inpDP" class="inp-price" style="width:140px; font-weight:bold; color:#0d47a1;" value="0" oninput="calculate()"></div></div>
            </div>
            <div style="padding:0 5px 20px 5px; color:#666; font-size:0.85rem;">
                <div style="display:flex; justify-content:space-between;"><span>Paket:</span><span id="dispPaket">0</span></div>
                <div style="display:flex; justify-content:space-between;"><span>Add-ons:</span><span id="dispAddons">0</span></div>
                <div style="display:flex; justify-content:space-between; color:#2e7d32;"><span id="lblOptional">Optional:</span><span id="dispOptional">0</span></div>
            </div>
        </div>
        <div class="m-footer">
            <div class="total-display"><span class="total-lbl">Kekurangan:</span><span id="dispFinal" class="total-val">0</span></div>
            <button class="btn-print" onclick="printReceipt()">üñ®Ô∏è CETAK NOTA</button>
        </div>
    </div>
</div>

<div id="receiptContainer">
    <img src="favicon-16.png" class="rc-watermark" alt="Logo">

    <div class="rc-header">
        <h1 class="rc-title">CANYONING PACET MOJOKERTO</h1>
        <p class="rc-subtitle">Jl. Wisata Air Panas KM. 0, Padusan, Hutan, Kec. Pacet</p>
        <p class="rc-subtitle">Kabupaten Mojokerto, Jawa Timur 61374</p>
    </div>
    <div class="rc-info">
        <div><span>Tanggal:</span> <span id="rcDate"></span></div>
        <div><span>Nama:</span> <span id="rcName" style="font-weight:bold;"></span></div>
    </div>
    <table class="rc-table">
        <thead><tr><th>Item</th><th class="rc-qty">Qty</th><th class="rc-right">Total</th></tr></thead>
        <tbody id="rcBody"></tbody>
    </table>
    <div class="rc-totals">
        <div class="rc-row"><span>Subtotal</span><span id="rcSubtotal">0</span></div>
        <div class="rc-row" style="color:#2e7d32;"><span>Sudah DP</span><span id="rcDP">0</span></div>
        <div class="rc-row rc-grand"><span id="rcLabelFinal">KEKURANGAN</span><span id="rcFinal">0</span></div>
    </div>
    <div class="rc-footer"><p>Terima Kasih atas kunjungan Anda.<br>Have a safe adventure!</p></div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzcDMlGtcoO2yY1wFd-ZMTyk3hs-dOmlUhnKd-rryL5JYAQSx-R07wRiP-A6D3bPl6Shg/exec"; 
    const SECRET_KEY = "adminslot"; 
    const PRICES = { SHOE: 15000, SHUTTLE: 10000, TIKET: 15000, OJEK: 15000, DRONE: 100000, CINEMATIC: 50000 };

    let CACHED_DATA = []; 
    let CACHED_HEADERS = []; 
    let activeRowElement = null; 
    let activeRowID = null; 

    document.addEventListener("DOMContentLoaded", init);

    async function init() {
        const loading = document.getElementById('loading');
        const keyInput = document.getElementById('adminKey');
        keyInput.addEventListener('input', function(e) {
            const secretDiv = document.getElementById('secretSection');
            if (e.target.value === SECRET_KEY) {
                secretDiv.style.display = 'block';
                renderSummary(CACHED_DATA);
            } else { secretDiv.style.display = 'none'; }
        });
        try {
            let response = await fetch(SCRIPT_URL);
            let sheets = await response.json();
            const select = document.getElementById('sheetSelector');
            sheets.forEach(sheet => {
                let opt = document.createElement('option');
                opt.value = sheet.gid; opt.innerText = sheet.name;
                select.appendChild(opt);
            });
            loading.style.display = 'none';
            document.getElementById('app').style.display = 'block';
            loadSheetData(sheets[0].gid);
            select.addEventListener('change', (e) => loadSheetData(e.target.value));
        } catch (err) { loading.innerHTML = "Error loading data."; }
    }

    async function loadSheetData(gid) {
        try {
            let res = await fetch(`${SCRIPT_URL}?gid=${gid}`);
            let rawData = await res.json();
            CACHED_HEADERS = rawData[0];
            CACHED_DATA = processData(rawData.slice(1));
            renderSchedule(CACHED_HEADERS, CACHED_DATA);
        } catch (err) { console.error(err); }
    }

    function processData(rows) {
        let result = []; let lastDate = null;
        rows.forEach(row => {
            let newRow = [...row];
            if ((!newRow[0] || newRow[0] === "") && lastDate) { newRow[0] = lastDate; }
            else { lastDate = newRow[0]; }
            result.push(newRow);
        });
        return result;
    }

    function renderSchedule(headers, data) {
        let groups = {};
        data.forEach(row => { if(!groups[row[0]]) groups[row[0]] = []; groups[row[0]].push(row); });
        const container = document.getElementById('scheduleList');
        container.innerHTML = "";
        for (let date in groups) {
            let itemDiv = document.createElement('div');
            itemDiv.className = 'accordion-item';
            let headerDiv = document.createElement('div');
            headerDiv.className = 'accordion-header';
            headerDiv.innerHTML = `<span class="date">${date}</span>`;
            let bodyDiv = document.createElement('div');
            bodyDiv.className = 'accordion-body';
            let tableHTML = `<div class="table-responsive"><table><thead><tr>`;
            for(let i=1; i<headers.length; i++) tableHTML += `<th>${headers[i]}</th>`;
            tableHTML += `<th>Aksi</th></tr></thead><tbody>`;
            groups[date].forEach(row => {
                let rowID = `BID_${row[0]}_${row[2]}`.replace(/\s/g, '');
                let isDone = localStorage.getItem(rowID) === "true";
                tableHTML += `<tr class="${isDone?'row-done':''}" data-id="${rowID}">`;
                for(let i=1; i<headers.length; i++) tableHTML += `<td>${row[i]||''}</td>`;
                tableHTML += `<td><button class="btn-action" onclick='openPaymentModal(${JSON.stringify(row)}, this)'><span>Hitung</span></button></td></tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            bodyDiv.innerHTML = tableHTML;
            itemDiv.appendChild(headerDiv); itemDiv.appendChild(bodyDiv);
            container.appendChild(itemDiv);
            headerDiv.onclick = () => { bodyDiv.style.maxHeight = bodyDiv.style.maxHeight ? null : bodyDiv.scrollHeight + "px"; };
        }
    }

    function openPaymentModal(row, btn) {
        activeRowElement = btn.closest('tr');
        activeRowID = activeRowElement.getAttribute('data-id');
        if (activeRowElement.classList.contains('row-done')) {
            if(confirm("Batalkan lunas?")) {
                localStorage.removeItem(activeRowID);
                activeRowElement.classList.remove('row-done');
            }
            return;
        }
        document.getElementById("modalName").innerText = row[2];
        document.getElementById("inpPaxQty").value = parseInt(row[1]) || 0;
        document.getElementById("paymentModal").style.display = "block";
        calculate();
    }

    function closeModal() { document.getElementById("paymentModal").style.display = "none"; }

    function calculate() {
        let qP = parseFloat(document.getElementById("inpPaxQty").value) || 0;
        let pP = parseFloat(document.getElementById("inpPaxPrice").value) || 0;
        let dp = parseFloat(document.getElementById("inpDP").value) || 0;
        let total = (qP * pP);
        // (Logika add-ons lainnya tetap sama seperti kode awal Anda)
        let final = total - dp;
        document.getElementById("dispFinal").innerText = formatRupiah(final);
    }

    function formatRupiah(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n); }

    function printReceipt() {
        const today = new Date();
        document.getElementById("rcDate").innerText = today.toLocaleDateString('id-ID');
        document.getElementById("rcName").innerText = document.getElementById("modalName").innerText;
        
        let body = document.getElementById("rcBody");
        body.innerHTML = `<tr><td>Paket Canyoning</td><td>x${document.getElementById("inpPaxQty").value}</td><td class="rc-right">${document.getElementById("dispPaket").innerText}</td></tr>`;
        
        document.getElementById("rcDP").innerText = formatRupiah(document.getElementById("inpDP").value);
        document.getElementById("rcFinal").innerText = document.getElementById("dispFinal").innerText;

        window.print();
        localStorage.setItem(activeRowID, "true");
        activeRowElement.classList.add('row-done');
        closeModal();
    }
    
    function renderSummary(data) { /* Fungsi rekap tetap sama */ }
    function clearPaidStatus() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>